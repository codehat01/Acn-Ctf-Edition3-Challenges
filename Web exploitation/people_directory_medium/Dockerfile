# Use debian:buster as the base image
FROM debian:buster

# Set environment variables to avoid prompts during installation
ENV DEBIAN_FRONTEND=noninteractive

# MariaDB root password to be passed as an environment variable
ENV MYSQL_PASSWORD=rootpassword

ENV SECURITY_KEY=dhdhdhdhdhdh
ENV FLAG=ACN_CTF{qwerttuip}

# Install necessary packages: curl, gnupg2, and dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    curl \
    gnupg2 \
    lsb-release \
    ca-certificates

# Install MariaDB
RUN apt-get update && \
    apt-get install -y --no-install-recommends mariadb-server && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Install Node.js 18.x
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - && \
    apt-get install -y --no-install-recommends nodejs && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Set the working directory for the Node.js application
WORKDIR /usr/src/app

# Copy the Node.js application code into the container
COPY . .

# Install Node.js dependencies
RUN npm install

# Expose ports for the Node.js app (3000) and MariaDB (3306)
EXPOSE 3000 3306

# Initialize MariaDB and set root password
RUN service mysql start && \
    mysql -e "SET PASSWORD FOR 'root'@'localhost' = PASSWORD('$MYSQL_PASSWORD'); FLUSH PRIVILEGES;"

# Start MariaDB and the Node.js app
CMD service mysql start && npm start
